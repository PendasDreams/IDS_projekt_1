DROP TABLE airplanes        CASCADE CONSTRAINTS;
DROP TABLE airlines         CASCADE CONSTRAINTS; 
DROP TABLE airports         CASCADE CONSTRAINTS;
DROP TABLE seats            CASCADE CONSTRAINTS;   
DROP TABLE seats_for_animal CASCADE CONSTRAINTS;
DROP TABLE flights          CASCADE CONSTRAINTS;
DROP TABLE customers        CASCADE CONSTRAINTS;
DROP TABLE reservations     CASCADE CONSTRAINTS;
DROP TABLE tickets          CASCADE CONSTRAINTS;

CREATE TABLE airlines (
    /* airline_id follows ICAO format */
    airline_id        VARCHAR(3) NOT NULL PRIMARY KEY CHECK (REGEXP_LIKE(airline_id, '[A-Z]{3}')),
    airline_callsign  VARCHAR(100) NOT NULL,
    residence         VARCHAR(100) NOT NULL
);

CREATE TABLE airplanes(
    airplane_id       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    manufacturer      VARCHAR(100),
    model             VARCHAR(100),
    wifi_connection_b CHAR(1) DEFAULT 'N' CHECK (wifi_connection_b IN ('Y','N')),
    airline           VARCHAR(3) CHECK (REGEXP_LIKE(airline, '[A-Z]{3}')),

CONSTRAINT airplane_owner_airline_fk FOREIGN KEY (airline) REFERENCES airlines(airline_id)
);   

CREATE TABLE airports (
    /* airport_id follows IATA format */
    airport_id      VARCHAR(3) NOT NULL PRIMARY KEY CHECK (REGEXP_LIKE(airport_id, '[A-Z]{3}')),
    country         VARCHAR(50) NOT NULL
);


CREATE TABLE flights (
    flights_id        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    departure_time    TIMESTAMP WITH TIME ZONE NOT NULL,
    arrival_time      TIMESTAMP WITH TIME ZONE NOT NULL,
    airplane          NUMBER,
    airline           VARCHAR(3) CHECK (REGEXP_LIKE(airline, '[A-Z]{3}')),
    origin            VARCHAR(3) CHECK (REGEXP_LIKE(origin, '[A-Z]{3}')),
    destination       VARCHAR(3) CHECK (REGEXP_LIKE(destination, '[A-Z]{3}')),

    CONSTRAINT flight_with_airplane_fk        FOREIGN KEY (airplane)    REFERENCES airplanes(airplane_id),
    CONSTRAINT flight_operated_by_airline_fk  FOREIGN KEY (airline)     REFERENCES airlines(airline_id),
    CONSTRAINT flight_origin_airport_fk       FOREIGN KEY (origin)      REFERENCES airports(airport_id),
    CONSTRAINT flight_destination_airport_fk  FOREIGN KEY (destination) REFERENCES airports(airport_id)

);

CREATE TABLE customers (
    customer_id      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    first_name       VARCHAR(50) NOT NULL,
    last_name        VARCHAR(50) NOT NULL,
    email            VARCHAR(100) NOT NULL CHECK (REGEXP_LIKE(email, '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}')),
    blacklist_b      CHAR(1) DEFAULT 'N' CHECK (blacklist_b IN ('Y','N'))
);

CREATE TABLE reservations (
    reservation_id  NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    cost            NUMBER(10,2) NOT NULL,
    payment_status  NUMBER NOT NULL CHECK(payment_status = 0 or payment_status = 1), -- true or false
    created_at      TIMESTAMP NOT NULL,
    created_by      NUMBER,
    owner           NUMBER,

    CONSTRAINT reservation_creator_fk FOREIGN KEY (owner) REFERENCES customers(customer_id)
);

CREATE TABLE tickets (
    ticket_id       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    cost            NUMBER NOT NULL,
    reservation     NUMBER NOT NULL,

    CONSTRAINT ticket_in_reservation_fk   FOREIGN KEY (reservation) REFERENCES reservations(reservation_id)
);

CREATE TABLE seats (
    seat_id     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    class       VARCHAR2(1) NOT NULL CHECK(REGEXP_LIKE(class, '[A-Z]')),
    cost        NUMBER,
    ticket      NUMBER,
    airline     VARCHAR(3) CHECK (REGEXP_LIKE(airline, '[A-Z]{3}')),   
    flight      NUMBER NOT NULL,
    
    /* uniqe klíč pro generalizaci */
    CONSTRAINT People_AltPK UNIQUE (seat_id, class,ticket,airline,flight),
    CONSTRAINT flight_seat_fk       FOREIGN KEY (flight)      REFERENCES flights(flights_id),
    CONSTRAINT seat_for_ticket_fk FOREIGN KEY (ticket) REFERENCES tickets(ticket_id),
    CONSTRAINT airline_seat_fk FOREIGN KEY (airline) REFERENCES airlines(airline_id)
);

CREATE TABLE seats_for_animal (
    seat_id     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    cage_size   VARCHAR2(1) NOT NULL CHECK(cage_size IN ('S', 'M', 'L')),
    /*
        S: SMALL
        M: MEDIUM
        L: LARGE
    */
    class       VARCHAR2(1) NOT NULL CHECK(class = 'A'),
    cost        NUMBER,
    ticket      NUMBER,
    airline     VARCHAR(3) CHECK (REGEXP_LIKE(airline, '[A-Z]{3}')),   
    flight      NUMBER NOT NULL,
    
    FOREIGN KEY (seat_id, class,ticket,airline,flight) REFERENCES seats(seat_id, class,ticket,airline,flight)
);



